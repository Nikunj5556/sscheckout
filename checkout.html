<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #1a1f36;
      color: #e3e8ee;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 3rem;
    }
    @media (max-width: 968px) {
      .container { grid-template-columns: 1fr; }
      .order-summary { order: -1; }
    }
    h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .subtitle { color: #8792a2; font-size: 0.9rem; margin-bottom: 2rem; }
    .store-info { color: #8792a2; font-size: 0.85rem; margin-bottom: 1rem; }
    .steps {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid #2d3748;
      padding-bottom: 1rem;
    }
    .step {
      padding: 0.75rem 1.5rem;
      background: transparent;
      color: #8792a2;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
    }
    .step.active { background: #5469d4; color: white; }
    .form-section { display: none; }
    .form-section.active { display: block; }
    .form-group { margin-bottom: 1.25rem; }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
    }
    input, select {
      width: 100%;
      padding: 0.75rem;
      background: #2d3748;
      border: 1px solid #4a5568;
      border-radius: 6px;
      color: #e3e8ee;
      font-size: 0.95rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #5469d4;
    }
    .button-group {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    button {
      padding: 0.875rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #5469d4;
      color: white;
      flex: 1;
    }
    .btn-primary:hover { background: #4353b8; }
    .btn-secondary {
      background: #2d3748;
      color: #e3e8ee;
    }
    .btn-secondary:hover { background: #3d4758; }
    .order-summary {
      background: #232938;
      padding: 1.5rem;
      border-radius: 12px;
      height: fit-content;
      position: sticky;
      top: 2rem;
    }
    .summary-title {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #2d3748;
    }
    .cart-item {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      border-bottom: 1px solid #2d3748;
    }
    .cart-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
    }
    .cart-item-info { flex: 1; }
    .cart-item-title {
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }
    .cart-item-variant {
      font-size: 0.85rem;
      color: #8792a2;
    }
    .cart-item-price {
      text-align: right;
      font-weight: 600;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
    }
    .summary-total {
      font-size: 1.25rem;
      font-weight: 700;
      border-top: 2px solid #2d3748;
      padding-top: 1rem;
      margin-top: 1rem;
    }
    .payment-methods { margin-top: 1.5rem; }
    .payment-method {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: #2d3748;
      border: 2px solid #4a5568;
      border-radius: 8px;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .payment-method:hover { border-color: #5469d4; }
    .payment-method.selected { border-color: #5469d4; background: #2d3e68; }
    .payment-method input[type="radio"] { margin-right: 0.75rem; }
    .success-screen {
      text-align: center;
      padding: 3rem 2rem;
      display: none;
    }
    .success-screen.active { display: block; }
    .success-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
    }
    .loading {
      display: none;
      text-align: center;
      padding: 2rem;
    }
    .spinner {
      border: 4px solid #2d3748;
      border-top: 4px solid #5469d4;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      background: #e53e3e;
      color: white;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: none;
    }
    .discount-row {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    .discount-input {
      flex: 1;
    }
    .discount-btn {
      padding: 0.75rem 1.5rem;
      background: #2d3748;
      color: #e3e8ee;
      border: 1px solid #4a5568;
    }
  </style>
</head>
<body>
  <div class="container">
    <main>
      <h1>Checkout</h1>
      <p class="subtitle">Secure payment powered by Razorpay â€” orders are synced to your Shopify store</p>
      <p class="store-info">Store: <span id="store-name">Loading...</span></p>

      <div class="steps">
        <button class="step active" data-step="1">1. Contact</button>
        <button class="step" data-step="2">2. Shipping</button>
        <button class="step" data-step="3">3. Payment</button>
      </div>

      <div class="error-message" id="error-message"></div>

      <!-- Step 1: Contact -->
      <div class="form-section active" data-section="1">
        <div class="form-group">
          <label for="fullname">Full name *</label>
          <input type="text" id="fullname" placeholder="Jane Doe" required>
        </div>
        <div class="form-group">
          <label for="email">Email *</label>
          <input type="email" id="email" placeholder="jane@example.com" required>
        </div>
        <div class="form-group">
          <label for="phone">Phone</label>
          <input type="tel" id="phone" placeholder="+91 98xxxxx">
        </div>
        <div class="button-group">
          <button class="btn-primary" onclick="goToStep(2)">Continue to shipping</button>
          <button class="btn-secondary" onclick="reloadCart()">Reload cart</button>
        </div>
      </div>

      <!-- Step 2: Shipping -->
      <div class="form-section" data-section="2">
        <div class="form-group">
          <label for="address">Street address *</label>
          <input type="text" id="address" placeholder="123 Main Street" required>
        </div>
        <div class="form-group">
          <label for="city">City *</label>
          <input type="text" id="city" placeholder="Mumbai" required>
        </div>
        <div class="form-group">
          <label for="postal">Postal code *</label>
          <input type="text" id="postal" placeholder="400001" required>
        </div>
        <div class="form-group">
          <label for="state">State / Union Territory *</label>
          <select id="state" required>
            <option value="">Select state</option>
            <option value="Andhra Pradesh">Andhra Pradesh</option>
            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
            <option value="Assam">Assam</option>
            <option value="Bihar">Bihar</option>
            <option value="Chhattisgarh">Chhattisgarh</option>
            <option value="Goa">Goa</option>
            <option value="Gujarat">Gujarat</option>
            <option value="Haryana">Haryana</option>
            <option value="Himachal Pradesh">Himachal Pradesh</option>
            <option value="Jharkhand">Jharkhand</option>
            <option value="Karnataka">Karnataka</option>
            <option value="Kerala">Kerala</option>
            <option value="Madhya Pradesh">Madhya Pradesh</option>
            <option value="Maharashtra">Maharashtra</option>
            <option value="Manipur">Manipur</option>
            <option value="Meghalaya">Meghalaya</option>
            <option value="Mizoram">Mizoram</option>
            <option value="Nagaland">Nagaland</option>
            <option value="Odisha">Odisha</option>
            <option value="Punjab">Punjab</option>
            <option value="Rajasthan">Rajasthan</option>
            <option value="Sikkim">Sikkim</option>
            <option value="Tamil Nadu">Tamil Nadu</option>
            <option value="Telangana">Telangana</option>
            <option value="Tripura">Tripura</option>
            <option value="Uttar Pradesh">Uttar Pradesh</option>
            <option value="Uttarakhand">Uttarakhand</option>
            <option value="West Bengal">West Bengal</option>
            <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
            <option value="Chandigarh">Chandigarh</option>
            <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
            <option value="Delhi">Delhi</option>
            <option value="Jammu and Kashmir">Jammu and Kashmir</option>
            <option value="Ladakh">Ladakh</option>
            <option value="Lakshadweep">Lakshadweep</option>
            <option value="Puducherry">Puducherry</option>
          </select>
        </div>
        <div class="button-group">
          <button class="btn-secondary" onclick="goToStep(1)">Back</button>
          <button class="btn-primary" onclick="goToStep(3)">Continue to payment</button>
        </div>
      </div>

      <!-- Step 3: Payment -->
      <div class="form-section" data-section="3">
        <h3>Payment</h3>
        <p style="color: #8792a2; margin-bottom: 1.5rem;">Choose how you'd like to pay</p>
        
        <div class="discount-row">
          <input type="text" id="discount-code" class="discount-input" placeholder="Have a discount code?">
          <button class="discount-btn" onclick="applyDiscount()">Apply</button>
        </div>

        <div class="payment-methods">
          <label class="payment-method" onclick="selectPayment('cod')">
            <input type="radio" name="payment" value="cod">
            <span>Cash on Delivery</span>
          </label>
          <label class="payment-method" onclick="selectPayment('upi')">
            <input type="radio" name="payment" value="upi">
            <span>UPI (Razorpay)</span>
          </label>
          <label class="payment-method" onclick="selectPayment('card')">
            <input type="radio" name="payment" value="card">
            <span>Card (Razorpay)</span>
          </label>
          <label class="payment-method" onclick="selectPayment('netbanking')">
            <input type="radio" name="payment" value="netbanking">
            <span>Netbanking (Razorpay)</span>
          </label>
        </div>

        <div class="button-group">
          <button class="btn-secondary" onclick="goToStep(2)">Back</button>
          <button class="btn-primary" onclick="completeOrder()">Complete order</button>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing your order...</p>
      </div>

      <!-- Success Screen -->
      <div class="success-screen" id="success-screen">
        <div class="success-icon">âœ…</div>
        <h2>Order placed â€” thank you!</h2>
        <p style="color: #8792a2; margin: 1rem 0;">A confirmation has been sent to your email (if provided).</p>
        <p style="margin-top: 1rem;">Shopify order id: <strong id="order-id"></strong></p>
        <button class="btn-primary" style="margin-top: 2rem;" onclick="window.location.reload()">Place another order</button>
      </div>
    </main>

    <!-- Order Summary -->
    <aside class="order-summary">
      <h2 class="summary-title">Order summary <span style="color: #8792a2; font-size: 0.9rem;">(Items: <span id="items-count">0</span>)</span></h2>
      
      <div id="cart-items">
        <p style="text-align: center; color: #8792a2; padding: 2rem;">Loading cart...</p>
      </div>

      <div class="summary-row">
        <span>Subtotal</span>
        <span id="subtotal">â‚¹0.00</span>
      </div>
      <div class="summary-row">
        <span>Discount</span>
        <span id="discount">-â‚¹0.00</span>
      </div>
      <div class="summary-row">
        <span>Shipping</span>
        <span id="shipping">â‚¹0.00</span>
      </div>
      <div class="summary-row summary-total">
        <span>Total</span>
        <span id="total">â‚¹0.00</span>
      </div>
      <p style="font-size: 0.75rem; color: #8792a2; margin-top: 0.5rem;">Taxes & shipping are estimates â€” final amounts used for payment are shown at checkout.</p>
    </aside>
  </div>

  <script>
    // ============================================
    // CART LOADING FUNCTIONALITY (NEW)
    // ============================================
    
    let cartData = null;
    let storeDomain = '';
    let selectedPayment = null;

    // Get store domain from various sources
    function getStoreDomain() {
      // Try URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const shopParam = urlParams.get('shop');
      if (shopParam) return shopParam;

      // Try sessionStorage
      const storedShop = sessionStorage.getItem('shopify_store');
      if (storedShop) return storedShop;

      // Default fallback
      return 'snapsnicker2025.myshopify.com'; // Replace with your store
    }

    // Initialize cart on page load
    async function initializeCart() {
      storeDomain = getStoreDomain();
      document.getElementById('store-name').textContent = storeDomain;

      console.log('ðŸ›’ Initializing cart for:', storeDomain);

      // Try sessionStorage first
      try {
        const storedCart = sessionStorage.getItem('shopify_cart');
        if (storedCart) {
          cartData = JSON.parse(storedCart);
          console.log('âœ… Cart loaded from sessionStorage:', cartData);
          if (cartData.items && cartData.items.length > 0) {
            displayCart(cartData);
            return;
          }
        }
      } catch (e) {
        console.warn('âš ï¸ Could not parse stored cart:', e);
      }

      // Fetch from Shopify
      await fetchCartFromShopify();
    }

    // Fetch cart from Shopify store
    async function fetchCartFromShopify() {
      console.log('ðŸ“¥ Fetching cart from Shopify...');
      
      try {
        const response = await fetch(`https://${storeDomain}/cart.js`);
        if (!response.ok) throw new Error('Cart fetch failed');
        
        cartData = await response.json();
        console.log('âœ… Cart fetched from Shopify:', cartData);
        
        // Store in sessionStorage for future use
        sessionStorage.setItem('shopify_cart', JSON.stringify(cartData));
        
        displayCart(cartData);
      } catch (error) {
        console.error('âŒ Could not fetch cart:', error);
        showEmptyCart();
      }
    }

    // Display cart items
    function displayCart(cart) {
      if (!cart || !cart.items || cart.items.length === 0) {
        showEmptyCart();
        return;
      }

      const cartContainer = document.getElementById('cart-items');
      const itemsCount = document.getElementById('items-count');
      const subtotalEl = document.getElementById('subtotal');
      const totalEl = document.getElementById('total');

      let itemsHTML = '';
      let subtotal = 0;

      cart.items.forEach(item => {
        const itemTotal = item.line_price; // in cents
        subtotal += itemTotal;

        itemsHTML += `
          <div class="cart-item">
            <img src="${item.image || '/placeholder.png'}" alt="${item.title}">
            <div class="cart-item-info">
              <div class="cart-item-title">${item.product_title}</div>
              ${item.variant_title ? `<div class="cart-item-variant">${item.variant_title}</div>` : ''}
              <div style="font-size: 0.85rem; color: #8792a2; margin-top: 0.25rem;">Qty: ${item.quantity}</div>
            </div>
            <div class="cart-item-price">â‚¹${(itemTotal / 100).toFixed(2)}</div>
          </div>
        `;
      });

      cartContainer.innerHTML = itemsHTML;
      itemsCount.textContent = cart.items.length;
      subtotalEl.textContent = `â‚¹${(subtotal / 100).toFixed(2)}`;
      totalEl.textContent = `â‚¹${(subtotal / 100).toFixed(2)}`;

      console.log('âœ… Cart displayed successfully');
    }

    // Show empty cart message
    function showEmptyCart() {
      const cartContainer = document.getElementById('cart-items');
      cartContainer.innerHTML = `
        <div style="text-align: center; padding: 2rem 1rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ›’</div>
          <h3 style="margin-bottom: 0.5rem;">Your cart is empty</h3>
          <p style="color: #8792a2; margin-bottom: 1.5rem;">Add products to your cart before checking out.</p>
          <a href="https://${storeDomain}" 
             style="display: inline-block; padding: 0.875rem 2rem; background: #5469d4; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
            Continue Shopping
          </a>
        </div>
      `;
    }

    // Reload cart button
    function reloadCart() {
      document.getElementById('cart-items').innerHTML = '<p style="text-align: center; color: #8792a2; padding: 2rem;">Reloading cart...</p>';
      fetchCartFromShopify();
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', initializeCart);

    // ============================================
    // EXISTING FUNCTIONALITY (UNCHANGED)
    // ============================================

    function goToStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
      
      document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
      document.querySelector(`.form-section[data-section="${step}"]`).classList.add('active');
    }

    function selectPayment(method) {
      selectedPayment = method;
      document.querySelectorAll('.payment-method').forEach(p => p.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      document.querySelector(`input[value="${method}"]`).checked = true;
    }

    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => errorEl.style.display = 'none', 5000);
    }

    function showLoading() {
      document.querySelectorAll('.form-section').forEach(s => s.style.display = 'none');
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      goToStep(3);
    }

    function showSuccess(orderId) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('success-screen').classList.add('active');
      document.getElementById('order-id').textContent = orderId;
      document.querySelector('main').style.display = 'none';
    }

    async function completeOrder() {
      if (!selectedPayment) {
        showError('Please select a payment method');
        return;
      }

      if (!cartData || !cartData.items || cartData.items.length === 0) {
        showError('Your cart is empty. Please add items before checking out.');
        return;
      }

      const checkoutData = {
        name: document.getElementById('fullname').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        shipping: {
          address: document.getElementById('address').value,
          city: document.getElementById('city').value,
          zip: document.getElementById('postal').value,
          state: document.getElementById('state').value,
        },
        cart: {
          items: cartData.items.map(item => ({
            variant_id: item.variant_id,
            quantity: item.quantity,
            price: item.price,
            title: item.product_title
          }))
        },
        paymentMethod: selectedPayment
      };

      if (!checkoutData.name || !checkoutData.email || !checkoutData.shipping.address) {
        showError('Please fill in all required fields');
        return;
      }

      showLoading();

      try {
        if (selectedPayment === 'cod') {
          await handleCODOrder(checkoutData);
        } else {
          await handleRazorpayPayment(checkoutData);
        }
      } catch (error) {
        hideLoading();
        showError(error.message || 'Order failed. Please try again.');
        console.error('Order error:', error);
      }
    }

    async function handleCODOrder(checkoutData) {
      const response = await fetch('https://sscheckout.vercel.app/api/create-shopify-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ checkoutData })
      });

      const result = await response.json();
      
      if (result.success) {
        showSuccess(result.shopify_order_id || 'COD-' + Date.now());
      } else {
        throw new Error(result.error || 'COD order failed');
      }
    }

    async function handleRazorpayPayment(checkoutData) {
      const totalAmount = cartData.items.reduce((sum, item) => sum + item.line_price, 0);

      const orderResponse = await fetch('https://sscheckout.vercel.app/api/create-razorpay-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: totalAmount })
      });

      const orderData = await orderResponse.json();
      
      if (!orderData.success) {
        throw new Error('Failed to create Razorpay order');
      }

      const options = {
        key: orderData.key_id,
        amount: totalAmount,
        currency: 'INR',
        name: 'Snapsnicker',
        description: 'Order Payment',
        order_id: orderData.order.id,
        handler: async function(response) {
          await verifyPayment(response, checkoutData);
        },
        prefill: {
          name: checkoutData.name,
          email: checkoutData.email,
          contact: checkoutData.phone
        },
        theme: { color: '#5469d4' }
      };

      const rzp = new Razorpay(options);
      rzp.on('payment.failed', function(response) {
        hideLoading();
        showError('Payment failed: ' + response.error.description);
      });
      
      hideLoading();
      rzp.open();
    }

    async function verifyPayment(razorpayResponse, checkoutData) {
      showLoading();

      const verifyResponse = await fetch('https://sscheckout.vercel.app/api/verify-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          razorpay_order_id: razorpayResponse.razorpay_order_id,
          razorpay_payment_id: razorpayResponse.razorpay_payment_id,
          razorpay_signature: razorpayResponse.razorpay_signature,
          checkoutData
        })
      });

      const result = await verifyResponse.json();

      if (result.success) {
        showSuccess(result.shopify_order_id || result.order_number);
      } else {
        throw new Error(result.error || 'Payment verification failed');
      }
    }

    function applyDiscount() {
      const code = document.getElementById('discount-code').value;
      if (code) {
        showError('Discount feature coming soon!');
      }
    }
  </script>
</body>
</html>
