<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Checkout - Snapsnicker</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .checkout-wrapper {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .checkout-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px 40px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      height: 50px;
      width: auto;
    }

    .brand-name {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .secure-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Main Container */
    .checkout-container {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 30px;
    }

    /* Form Section */
    .form-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 1.6rem;
      font-weight: 700;
      margin-bottom: 30px;
      color: #1f2937;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
      font-size: 0.95rem;
    }

    .required {
      color: #ef4444;
    }

    input, textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s;
      background: white;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    input[readonly] {
      background: #f9fafb;
      cursor: not-allowed;
    }

    /* Custom Dropdown */
    .custom-select {
      position: relative;
      width: 100%;
    }

    .select-box {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }

    .select-box:hover, .select-box.active {
      border-color: #667eea;
    }

    .select-box.placeholder .select-value {
      color: #9ca3af;
    }

    .select-arrow {
      transition: transform 0.3s;
      color: #6b7280;
    }

    .select-box.active .select-arrow {
      transform: rotate(180deg);
    }

    .options {
      position: absolute;
      top: calc(100% + 5px);
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .search-box {
      position: sticky;
      top: 0;
      background: #f9fafb;
      padding: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    .search-box input {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      margin: 0;
    }

    .option {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.95rem;
    }

    .option:hover {
      background: #f3f4f6;
    }

    .option.selected {
      background: #ede9fe;
      color: #6d28d9;
      font-weight: 600;
    }

    /* Summary Section */
    .summary-section {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .summary-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 25px;
      color: #1f2937;
    }

    .cart-items {
      max-height: 350px;
      overflow-y: auto;
      margin-bottom: 25px;
    }

    .cart-item {
      display: flex;
      gap: 15px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 12px;
      margin-bottom: 15px;
    }

    .item-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 10px;
    }

    .item-details {
      flex: 1;
    }

    .item-name {
      font-weight: 700;
      margin-bottom: 5px;
      color: #1f2937;
    }

    .item-meta {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .item-price {
      font-weight: 700;
      color: #667eea;
      font-size: 1.1rem;
    }

    /* Discount Code */
    .discount-section {
      margin-bottom: 25px;
    }

    .discount-input-group {
      display: flex;
      gap: 10px;
    }

    .discount-input {
      flex: 1;
    }

    .apply-discount-btn {
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .apply-discount-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .discount-message {
      margin-top: 10px;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }

    .discount-message.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
      display: block;
    }

    .discount-message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
      display: block;
    }

    /* Price Summary */
    .price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-size: 1rem;
    }

    .price-label {
      color: #6b7280;
      font-weight: 500;
    }

    .price-value {
      font-weight: 600;
      color: #1f2937;
    }

    .discount-value {
      color: #10b981;
    }

    .total-row {
      display: flex;
      justify-content: space-between;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
      margin-top: 20px;
      margin-bottom: 25px;
    }

    .total-label {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1f2937;
    }

    .total-value {
      font-size: 1.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Payment Methods */
    .payment-methods {
      margin-bottom: 25px;
    }

    .payment-title {
      font-weight: 700;
      margin-bottom: 15px;
      color: #1f2937;
    }

    .payment-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .payment-option {
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      background: white;
    }

    .payment-option:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }

    .payment-option.active {
      background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
      border-color: #667eea;
      color: #5b21b6;
    }

    .cod-note {
      margin-top: 15px;
      padding: 12px;
      background: #fef3c7;
      border: 2px solid #fbbf24;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #78350f;
      display: none;
    }

    .cod-note.show {
      display: block;
    }

    /* Submit Button */
    .submit-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
    }

    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
    }

    .submit-btn:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Trust Badges */
    .trust-badges {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .trust-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: #6b7280;
      font-weight: 600;
    }

    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-content {
      background: white;
      padding: 50px;
      border-radius: 20px;
      text-align: center;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f4f6;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.3rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 10px;
    }

    .loading-subtext {
      color: #6b7280;
    }

    /* Success/Error Screens */
    .success-container, .error-container {
      display: none;
      max-width: 600px;
      margin: 100px auto;
      background: white;
      padding: 60px 40px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .success-container.show, .error-container.show {
      display: block;
    }

    .success-icon {
      font-size: 5rem;
      margin-bottom: 25px;
      animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .error-icon {
      font-size: 5rem;
      margin-bottom: 25px;
    }

    .success-title, .error-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 15px;
      color: #1f2937;
    }

    .success-message, .error-message {
      font-size: 1.1rem;
      color: #6b7280;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .success-btn, .error-btn {
      padding: 15px 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
    }

    /* Responsive */
    @media (max-width: 968px) {
      .checkout-container {
        grid-template-columns: 1fr;
      }

      .summary-section {
        position: relative;
        top: 0;
      }

      .checkout-header {
        padding: 20px;
      }

      .form-section, .summary-section {
        padding: 25px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 10px;
      }

      .checkout-header {
        flex-direction: column;
        gap: 15px;
      }

      .brand-name {
        font-size: 1.4rem;
      }

      .payment-options {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="checkout-wrapper">
    <!-- Header -->
    <header class="checkout-header">
      <div class="logo-section">
        <img src="https://xdieivjjxxqgullwrzhq.supabase.co/storage/v1/object/public/logo/log.png" alt="Logo" class="logo">
        <div class="brand-name">Snapsnicker</div>
      </div>
      <div class="secure-badge">
        <span>üîí</span>
        <span>Secure Checkout</span>
      </div>
    </header>

    <!-- Main Content -->
    <div class="checkout-container" id="mainContent">
      <!-- Form Section -->
      <div class="form-section">
        <h2 class="section-title">Shipping Information</h2>
        <form id="checkoutForm">
          <div class="form-grid">
            <div class="form-group">
              <label>First Name <span class="required">*</span></label>
              <input type="text" id="firstName" required placeholder="John">
            </div>
            <div class="form-group">
              <label>Last Name <span class="required">*</span></label>
              <input type="text" id="lastName" required placeholder="Doe">
            </div>
          </div>

          <div class="form-group">
            <label>Email Address <span class="required">*</span></label>
            <input type="email" id="email" required placeholder="john@example.com">
          </div>

          <div class="form-group">
            <label>Phone Number <span class="required">*</span></label>
            <input type="tel" id="phone" required placeholder="+91 98765 43210" pattern="[0-9+\s\-()]+">
          </div>

          <div class="form-group">
            <label>Address Line 1 <span class="required">*</span></label>
            <input type="text" id="address1" required placeholder="Street address, P.O. box">
          </div>

          <div class="form-group">
            <label>Address Line 2</label>
            <input type="text" id="address2" placeholder="Apartment, suite, unit, etc.">
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>City <span class="required">*</span></label>
              <input type="text" id="city" required placeholder="Mumbai">
            </div>
            <div class="form-group">
              <label>State <span class="required">*</span></label>
              <div class="custom-select">
                <div class="select-box placeholder" tabindex="0">
                  <span class="select-value">Select State</span>
                  <span class="select-arrow">‚ñº</span>
                </div>
                <div class="options">
                  <div class="search-box">
                    <input type="text" placeholder="Search state..." autocomplete="off">
                  </div>
                  <div class="option" data-value="Andhra Pradesh" data-initials="AP">Andhra Pradesh</div>
                  <div class="option" data-value="Arunachal Pradesh" data-initials="AR">Arunachal Pradesh</div>
                  <div class="option" data-value="Assam" data-initials="AS">Assam</div>
                  <div class="option" data-value="Bihar" data-initials="BR">Bihar</div>
                  <div class="option" data-value="Chhattisgarh" data-initials="CG">Chhattisgarh</div>
                  <div class="option" data-value="Goa" data-initials="GA">Goa</div>
                  <div class="option" data-value="Gujarat" data-initials="GJ">Gujarat</div>
                  <div class="option" data-value="Haryana" data-initials="HR">Haryana</div>
                  <div class="option" data-value="Himachal Pradesh" data-initials="HP">Himachal Pradesh</div>
                  <div class="option" data-value="Jharkhand" data-initials="JH">Jharkhand</div>
                  <div class="option" data-value="Karnataka" data-initials="KA">Karnataka</div>
                  <div class="option" data-value="Kerala" data-initials="KL">Kerala</div>
                  <div class="option" data-value="Madhya Pradesh" data-initials="MP">Madhya Pradesh</div>
                  <div class="option" data-value="Maharashtra" data-initials="MH">Maharashtra</div>
                  <div class="option" data-value="Manipur" data-initials="MN">Manipur</div>
                  <div class="option" data-value="Meghalaya" data-initials="ML">Meghalaya</div>
                  <div class="option" data-value="Mizoram" data-initials="MZ">Mizoram</div>
                  <div class="option" data-value="Nagaland" data-initials="NL">Nagaland</div>
                  <div class="option" data-value="Odisha" data-initials="OR">Odisha</div>
                  <div class="option" data-value="Punjab" data-initials="PB">Punjab</div>
                  <div class="option" data-value="Rajasthan" data-initials="RJ">Rajasthan</div>
                  <div class="option" data-value="Sikkim" data-initials="SK">Sikkim</div>
                  <div class="option" data-value="Tamil Nadu" data-initials="TN">Tamil Nadu</div>
                  <div class="option" data-value="Telangana" data-initials="TG">Telangana</div>
                  <div class="option" data-value="Tripura" data-initials="TR">Tripura</div>
                  <div class="option" data-value="Uttar Pradesh" data-initials="UP">Uttar Pradesh</div>
                  <div class="option" data-value="Uttarakhand" data-initials="UK">Uttarakhand</div>
                  <div class="option" data-value="West Bengal" data-initials="WB">West Bengal</div>
                  <div class="option" data-value="Andaman and Nicobar Islands" data-initials="AN">Andaman and Nicobar Islands</div>
                  <div class="option" data-value="Chandigarh" data-initials="CH">Chandigarh</div>
                  <div class="option" data-value="Dadra and Nagar Haveli and Daman and Diu" data-initials="DH">Dadra and Nagar Haveli and Daman and Diu</div>
                  <div class="option" data-value="Delhi" data-initials="DL">Delhi</div>
                  <div class="option" data-value="Jammu and Kashmir" data-initials="JK">Jammu and Kashmir</div>
                  <div class="option" data-value="Ladakh" data-initials="LA">Ladakh</div>
                  <div class="option" data-value="Lakshadweep" data-initials="LD">Lakshadweep</div>
                  <div class="option" data-value="Puducherry" data-initials="PY">Puducherry</div>
                </div>
                <input type="hidden" id="state" required>
              </div>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>PIN Code <span class="required">*</span></label>
              <input type="text" id="pincode" required placeholder="400001" pattern="[0-9]{6}" maxlength="6">
            </div>
            <div class="form-group">
              <label>Country <span class="required">*</span></label>
              <input type="text" id="country" value="India" readonly>
            </div>
          </div>
        </form>
      </div>

      <!-- Summary Section -->
      <div class="summary-section">
        <h3 class="summary-title">Order Summary</h3>

        <div class="cart-items" id="cartItems">
          <!-- Cart items will be populated here -->
        </div>

        <!-- Discount Code Section -->
        <div class="discount-section">
          <label>Discount Code</label>
          <div class="discount-input-group">
            <input type="text" id="discountCode" class="discount-input" placeholder="Enter code">
            <button type="button" class="apply-discount-btn" onclick="applyDiscount()">Apply</button>
          </div>
          <div class="discount-message" id="discountMessage"></div>
        </div>

        <!-- Price Summary -->
        <div class="price-row">
          <span class="price-label">Subtotal</span>
          <span class="price-value" id="subtotalValue">‚Çπ0.00</span>
        </div>
        <div class="price-row">
          <span class="price-label">Discount</span>
          <span class="price-value discount-value" id="discountValue">-‚Çπ0.00</span>
        </div>
        <div class="price-row">
          <span class="price-label">Shipping</span>
          <span class="price-value">FREE</span>
        </div>
        <div class="total-row">
          <span class="total-label">Total</span>
          <span class="total-value" id="totalValue">‚Çπ0.00</span>
        </div>

        <!-- Payment Methods -->
        <div class="payment-methods">
          <div class="payment-title">Payment Method</div>
          <div class="payment-options">
            <div class="payment-option active" data-method="online" onclick="selectPaymentMethod('online')">
              üí≥ Online Payment
            </div>
            <div class="payment-option" data-method="cod" onclick="selectPaymentMethod('cod')">
              üíµ Cash on Delivery
            </div>
          </div>
          <div class="cod-note" id="codNote">
            ‚ö†Ô∏è COD available with ‚Çπ300 confirmation fee
          </div>
        </div>

        <button type="submit" form="checkoutForm" class="submit-btn">
          Place Order
        </button>

        <div class="trust-badges">
          <div class="trust-badge">üîí SSL Secure</div>
          <div class="trust-badge">‚úì Safe Payment</div>
          <div class="trust-badge">üöö Fast Delivery</div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text">Processing your order...</div>
        <div class="loading-subtext">Please wait</div>
      </div>
    </div>

    <!-- Error Screen -->
    <div class="error-container" id="errorContainer">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h3 class="error-title">Oops! Something went wrong</h3>
      <p class="error-message" id="errorMessage">
        We couldn't retrieve your cart. Please try again.
      </p>
      <button class="error-btn" onclick="window.location.href='/'">
        Return to Store
      </button>
    </div>

    <!-- Success Screen -->
    <div class="success-container" id="successContainer">
      <div class="success-icon">üéâ</div>
      <h3 class="success-title">Order Placed Successfully!</h3>
      <p class="success-message">
        Thank you for your order!<br>
        You'll receive a confirmation email shortly with order details.
      </p>
      <button class="success-btn" onclick="window.location.href='/'">
        Continue Shopping
      </button>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const SUPABASE_URL = 'https://xdieivjjxxqgullwrzhq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkaWVpdmpqeHhxZ3VsbHdyemhxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NDU3NTYsImV4cCI6MjA3ODUyMTc1Nn0.Y2VIOiJq4aRjd6hTxvkYk4sJJyCFio0NQ7SlLLYZ9xM';
    const RAZORPAY_KEY_ID = 'rzp_live_3v7BmF6j3iuh2u';
    const RAZORPAY_KEY_SECRET = '9NsWOguCt5el1IMs9duCoLBH';
    const RAZORPAY_WEBHOOK_SECRET = '321@abczx';
    const COD_CONFIRMATION_AMOUNT = 300;

    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== STATE =====
    let cart = [];
    let subtotal = 0;
    let discount = 0;
    let total = 0;
    let isCOD = false;
    let selectedState = '';
    let appliedDiscountCode = null;

    // Sample discount codes (stored in memory for prototype)
    const DISCOUNT_CODES = {
      'SAVE10': { type: 'percentage', value: 10, description: '10% off' },
      'SAVE20': { type: 'percentage', value: 20, description: '20% off' },
      'FLAT100': { type: 'fixed', value: 100, description: '‚Çπ100 off' },
      'FLAT500': { type: 'fixed', value: 500, description: '‚Çπ500 off' },
      'WELCOME': { type: 'percentage', value: 15, description: '15% off for new customers' }
    };

    // ===== INITIALIZATION =====
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Checkout page loaded');
      loadCartData();
      setupCustomDropdown();
      setupFormSubmit();
    });

    // ===== LOAD CART DATA =====
    function loadCartData() {
      try {
        // Try to get cart from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get('d');

        if (encodedData) {
          const decodedData = JSON.parse(decodeURIComponent(atob(encodedData)));
          processCartData(decodedData);
          return;
        }

        // Try to get cart from localStorage
        const localData = localStorage.getItem('sscheckout_cart');
        if (localData) {
          const decodedData = JSON.parse(decodeURIComponent(atob(localData)));
          processCartData(decodedData);
          localStorage.removeItem('sscheckout_cart');
          return;
        }

        // No cart data found - show demo data for prototype
        console.log('No cart data found, loading demo data');
        loadDemoData();

      } catch (error) {
        console.error('Error loading cart:', error);
        loadDemoData(); // Fallback to demo data
      }
    }

    function loadDemoData() {
      // Demo cart data for testing
      const demoCart = {
        items: [
          {
            name: 'Premium T-Shirt',
            price: 999,
            quantity: 2,
            size: 'L',
            image: 'https://via.placeholder.com/80'
          },
          {
            name: 'Designer Hoodie',
            price: 1999,
            quantity: 1,
            size: 'M',
            image: 'https://via.placeholder.com/80'
          }
        ],
        subtotal: 3997,
        discount: 0,
        total: 3997
      };
      processCartData(demoCart);
    }

    function processCartData(data) {
      cart = data.items || [];
      subtotal = data.subtotal || 0;
      discount = data.discount || 0;
      total = data.total || 0;

      if (cart.length === 0) {
        showError('Your cart is empty. Please add items before checkout.');
        return;
      }

      renderCart();
      updatePriceSummary();
    }

    function renderCart() {
      const cartContainer = document.getElementById('cartItems');
      cartContainer.innerHTML = '';

      cart.forEach(item => {
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
          <img src="${item.image || 'https://via.placeholder.com/80'}" alt="${item.name}" class="item-image">
          <div class="item-details">
            <div class="item-name">${item.name}</div>
            <div class="item-meta">Qty: ${item.quantity} | Size: ${item.size || 'N/A'}</div>
            <div class="item-price">‚Çπ${(item.price * item.quantity).toFixed(2)}</div>
          </div>
        `;
        cartContainer.appendChild(cartItem);
      });
    }

    function updatePriceSummary() {
      document.getElementById('subtotalValue').textContent = `‚Çπ${subtotal.toFixed(2)}`;
      document.getElementById('discountValue').textContent = `-‚Çπ${discount.toFixed(2)}`;
      document.getElementById('totalValue').textContent = `‚Çπ${total.toFixed(2)}`;
    }

    // ===== CUSTOM DROPDOWN =====
    function setupCustomDropdown() {
      const selectBox = document.querySelector('.select-box');
      const selectValue = selectBox.querySelector('.select-value');
      const optionsContainer = document.querySelector('.options');
      const options = document.querySelectorAll('.option');
      const searchInput = document.querySelector('.search-box input');
      const hiddenInput = document.getElementById('state');

      selectBox.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = optionsContainer.style.display === 'block';
        optionsContainer.style.display = isVisible ? 'none' : 'block';
        selectBox.classList.toggle('active', !isVisible);
        if (!isVisible) {
          searchInput.focus();
          searchInput.value = '';
          filterOptions('');
        }
      });

      options.forEach(option => {
        option.addEventListener('click', () => {
          selectedState = option.dataset.value;
          selectValue.textContent = selectedState;
          hiddenInput.value = selectedState;
          selectBox.classList.remove('placeholder');
          options.forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');
          optionsContainer.style.display = 'none';
          selectBox.classList.remove('active');
        });
      });

      searchInput.addEventListener('input', (e) => {
        filterOptions(e.target.value);
      });

      searchInput.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      function filterOptions(searchTerm) {
        const filter = searchTerm.trim().toLowerCase();
        options.forEach(option => {
          const text = option.textContent.toLowerCase();
          const initials = option.dataset.initials.toLowerCase();
          const matches = text.includes(filter) || initials.includes(filter);
          option.style.display = matches ? 'block' : 'none';
        });
      }

      document.addEventListener('click', () => {
        optionsContainer.style.display = 'none';
        selectBox.classList.remove('active');
      });
    }

    // ===== DISCOUNT CODE =====
    function applyDiscount() {
      const code = document.getElementById('discountCode').value.trim().toUpperCase();
      const message = document.getElementById('discountMessage');

      if (!code) {
        showDiscountMessage('Please enter a discount code', 'error');
        return;
      }

      const discountInfo = DISCOUNT_CODES[code];

      if (!discountInfo) {
        showDiscountMessage('Invalid discount code', 'error');
        return;
      }

      // Calculate discount
      if (discountInfo.type === 'percentage') {
        discount = (subtotal * discountInfo.value) / 100;
      } else if (discountInfo.type === 'fixed') {
        discount = discountInfo.value;
      }

      // Ensure discount doesn't exceed subtotal
      discount = Math.min(discount, subtotal);

      appliedDiscountCode = code;
      total = subtotal - discount + (isCOD ? COD_CONFIRMATION_AMOUNT : 0);

      updatePriceSummary();
      showDiscountMessage(`‚úì ${discountInfo.description} applied!`, 'success');
    }

    function showDiscountMessage(text, type) {
      const message = document.getElementById('discountMessage');
      message.textContent = text;
      message.className = `discount-message ${type}`;
      setTimeout(() => {
        if (type === 'error') {
          message.className = 'discount-message';
        }
      }, 3000);
    }

    // ===== PAYMENT METHOD =====
    function selectPaymentMethod(method) {
      isCOD = method === 'cod';

      document.querySelectorAll('.payment-option').forEach(option => {
        option.classList.remove('active');
      });

      document.querySelector(`[data-method="${method}"]`).classList.add('active');
      document.getElementById('codNote').classList.toggle('show', isCOD);

      // Recalculate total
      total = subtotal - discount + (isCOD ? COD_CONFIRMATION_AMOUNT : 0);
      updatePriceSummary();
    }

    // ===== FORM SUBMISSION =====
    function setupFormSubmit() {
      const form = document.getElementById('checkoutForm');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!selectedState) {
          alert('Please select a state');
          return;
        }

        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const formData = {
          firstName: document.getElementById('firstName').value.trim(),
          lastName: document.getElementById('lastName').value.trim(),
          email: document.getElementById('email').value.trim(),
          phone: document.getElementById('phone').value.trim(),
          address1: document.getElementById('address1').value.trim(),
          address2: document.getElementById('address2').value.trim(),
          city: document.getElementById('city').value.trim(),
          state: selectedState,
          pincode: document.getElementById('pincode').value.trim(),
          country: document.getElementById('country').value.trim()
        };

        if (isCOD) {
          await processCODOrder(formData);
        } else {
          await processOnlinePayment(formData);
        }
      });
    }

    // ===== COD ORDER =====
    async function processCODOrder(formData) {
      showLoading();

      try {
        const orderData = {
          ...formData,
          items: cart,
          subtotal: subtotal,
          discount: discount,
          discountCode: appliedDiscountCode,
          codFee: COD_CONFIRMATION_AMOUNT,
          total: total,
          paymentMethod: 'COD',
          paymentStatus: 'Pending',
          orderStatus: 'Confirmed',
          createdAt: new Date().toISOString()
        };

        // Store order in Supabase
        const { data, error } = await supabase
          .from('orders')
          .insert([orderData])
          .select();

        if (error) throw error;

        hideLoading();
        showSuccess();
        console.log('COD Order placed:', data);

      } catch (error) {
        console.error('COD order error:', error);
        hideLoading();
        showError('Failed to place COD order. Please try again.');
      }
    }

    // ===== ONLINE PAYMENT =====
    async function processOnlinePayment(formData) {
      showLoading();

      try {
        // Create Razorpay order (client-side for prototype)
        const amountPaise = Math.round(total * 100);

        hideLoading();

        const options = {
          key: RAZORPAY_KEY_ID,
          amount: amountPaise,
          currency: 'INR',
          name: 'Snapsnicker',
          description: 'Order Payment',
          image: 'https://xdieivjjxxqgullwrzhq.supabase.co/storage/v1/object/public/logo/log.png',
          handler: async function(response) {
            await verifyAndStorePayment(response, formData);
          },
          prefill: {
            name: `${formData.firstName} ${formData.lastName}`,
            email: formData.email,
            contact: formData.phone
          },
          theme: {
            color: '#667eea'
          },
          modal: {
            ondismiss: function() {
              console.log('Payment cancelled');
            }
          }
        };

        const razorpay = new Razorpay(options);
        razorpay.open();

      } catch (error) {
        console.error('Payment error:', error);
        hideLoading();
        showError('Failed to initiate payment. Please try again.');
      }
    }

    async function verifyAndStorePayment(response, formData) {
      showLoading();

      try {
        const orderData = {
          ...formData,
          items: cart,
          subtotal: subtotal,
          discount: discount,
          discountCode: appliedDiscountCode,
          total: total,
          paymentMethod: 'Online',
          paymentStatus: 'Paid',
          paymentId: response.razorpay_payment_id,
          orderId: response.razorpay_order_id || `order_${Date.now()}`,
          signature: response.razorpay_signature,
          orderStatus: 'Confirmed',
          createdAt: new Date().toISOString()
        };

        // Store order in Supabase
        const { data, error } = await supabase
          .from('orders')
          .insert([orderData])
          .select();

        if (error) throw error;

        hideLoading();
        showSuccess();
        console.log('Online payment order placed:', data);

      } catch (error) {
        console.error('Payment verification error:', error);
        hideLoading();
        showError('Payment completed but order storage failed. Please contact support.');
      }
    }

    // ===== UI HELPERS =====
    function showLoading() {
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    function showError(message) {
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('errorContainer').classList.add('show');
      document.getElementById('errorMessage').textContent = message;
    }

    function showSuccess() {
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('successContainer').classList.add('show');
    }
  </script>
</body>
</html>
