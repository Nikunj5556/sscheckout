<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout ‚Äî Your Store</title>

  <style>
    :root{
      --bg:#0f1720; --card:#0b1220; --muted:#9aa6bb; --accent:#667eea; --panel:#0b1227;
      --radius:12px; --maxw:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,Roboto,Arial; background:linear-gradient(180deg,#071026 0,#071229 100%); color:#e6eef8; min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:36px;}
    .shell{width:100%; max-width:var(--maxw); display:grid; grid-template-columns:1fr 420px; gap:28px}
    @media(max-width:980px){ .shell{grid-template-columns:1fr; padding:12px} }

    .card { background:var(--card); border-radius:var(--radius); padding:22px; box-shadow:0 10px 40px rgba(2,6,23,.6); }
    .hero{margin-bottom:12px}
    h1{font-size:20px; margin:0 0 6px}
    .muted{color:var(--muted); font-size:13px}

    /* steps */
    .steps{display:flex; gap:8px; margin-bottom:18px}
    .step{flex:1; padding:8px 10px; border-radius:10px; background:#06101a; text-align:center; font-weight:700; color:var(--muted)}
    .step.active{background:linear-gradient(90deg,var(--accent),#4b6cf0); color:#fff}

    form .field{margin-top:12px}
    label{display:block; color:#e8f0ff; font-size:13px; margin-bottom:6px}
    input[type="text"], input[type="email"], input[type="tel"], select {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:#071426; color:#fff;
    }

    .row{display:flex; gap:10px}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:700}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#4b6cf0); color:#fff}
    .btn.ghost{background:#081224; color:var(--muted); border:1px solid rgba(255,255,255,.03)}

    /* summary */
    .summary{position:sticky; top:24px}
    .summary h3{margin:0 0 10px}
    .item{display:flex; justify-content:space-between; gap:12px; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,0.03)}
    .small{font-size:13px;color:var(--muted)}

    .totals{margin-top:12px; padding-top:10px; border-top:1px dashed rgba(255,255,255,0.03)}
    .totals .line{display:flex; justify-content:space-between; margin:8px 0}
    .totals .total{font-weight:800; font-size:18px}

    .payment-options{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px}
    .pay-opt{padding:12px; border-radius:10px; background:#071226; border:1px solid rgba(255,255,255,0.02); cursor:pointer; text-align:center}
    .pay-opt.selected{box-shadow:0 10px 30px rgba(102,126,234,0.12); border-color:rgba(102,126,234,0.28)}

    /* loading overlay */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(3,6,12,0.6); z-index:9999}
    .spinner{width:56px;height:56px;border-radius:50%;border:6px solid rgba(255,255,255,0.08);border-top-color:var(--accent); animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .thank{ text-align:center; padding:20px }
    .error{color:#ffb4b4; background:rgba(255,64,64,0.06); padding:10px; border-radius:8px; margin-top:10px }
  </style>
</head>
<body>
  <div class="overlay" id="overlay"><div class="spinner"></div></div>

  <div class="shell">
    <!-- LEFT: main checkout -->
    <div>
      <div class="card hero">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h1>Checkout</h1>
            <div class="muted">Secure payment powered by Razorpay ‚Äî orders are synced to your Shopify store</div>
          </div>
          <div class="small muted">Store: <span id="shopDomain">-</span></div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <div class="steps">
          <div class="step active" data-step="1">1. Contact</div>
          <div class="step" data-step="2">2. Shipping</div>
          <div class="step" data-step="3">3. Payment</div>
        </div>

        <!-- Step 1: Contact -->
        <div id="step-1">
          <form id="contactForm">
            <label>Full name *</label>
            <input id="name" type="text" placeholder="Jane Doe" required>

            <label>Email *</label>
            <input id="email" type="email" placeholder="jane@example.com" required>

            <label>Phone</label>
            <input id="phone" type="tel" placeholder="+91 98xxxx">

            <div style="display:flex;gap:10px;margin-top:12px">
              <button class="btn primary" type="submit">Continue to shipping</button>
              <button class="btn ghost" type="button" id="loadCartBtn">Reload cart</button>
            </div>
          </form>
        </div>

        <!-- Step 2: Shipping -->
        <div id="step-2" style="display:none">
          <form id="shippingForm">
            <label>Street address *</label>
            <input id="street" type="text" placeholder="123 Main Street" required>

            <div class="row" style="margin-top:10px">
              <div style="flex:1">
                <label>City *</label>
                <input id="city" type="text" placeholder="Mumbai" required>
              </div>
              <div style="width:140px">
                <label>Postal code *</label>
                <input id="postal" type="text" placeholder="400001" pattern="[0-9]{6}" required>
              </div>
            </div>

            <label style="margin-top:10px">State / Union Territory *</label>
            <select id="state" required>
              <option value="">Select state</option>
              <option>Andhra Pradesh</option><option>Arunachal Pradesh</option><option>Assam</option>
              <option>Bihar</option><option>Chhattisgarh</option><option>Goa</option><option>Gujarat</option>
              <option>Haryana</option><option>Himachal Pradesh</option><option>Jharkhand</option>
              <option>Karnataka</option><option>Kerala</option><option>Madhya Pradesh</option>
              <option>Maharashtra</option><option>Manipur</option><option>Meghalaya</option>
              <option>Mizoram</option><option>Nagaland</option><option>Odisha</option>
              <option>Punjab</option><option>Rajasthan</option><option>Sikkim</option>
              <option>Tamil Nadu</option><option>Telangana</option><option>Tripura</option>
              <option>Uttar Pradesh</option><option>Uttarakhand</option><option>West Bengal</option>
              <option>Andaman and Nicobar Islands</option><option>Chandigarh</option>
              <option>Dadra and Nagar Haveli and Daman and Diu</option><option>Delhi</option>
              <option>Jammu and Kashmir</option><option>Ladakh</option><option>Lakshadweep</option>
              <option>Puducherry</option>
            </select>

            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn ghost" type="button" id="backToContact">Back</button>
              <button class="btn primary" type="submit">Continue to payment</button>
            </div>
          </form>
        </div>

        <!-- Step 3: Payment -->
        <div id="step-3" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h3 style="margin:0">Payment</h3>
              <div class="muted" style="margin-top:6px">Choose how you'd like to pay</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label class="small">Have a discount code?</label>
            <div style="display:flex; gap:8px; margin-top:8px">
              <input id="discountCode" type="text" placeholder="ENTER CODE" style="flex:1; padding:10px; border-radius:8px; background:#071426; color:#fff; border:1px solid rgba(255,255,255,0.03)">
              <button class="btn ghost" id="applyDiscountBtn">Apply</button>
            </div>
            <div id="discountMsg" class="small" style="margin-top:8px"></div>
          </div>

          <div class="payment-options" id="paymentOptions" style="margin-top:12px">
            <div class="pay-opt" data-method="cod">üì¶<div class="small muted">Cash on Delivery</div></div>
            <div class="pay-opt" data-method="upi">üì±<div class="small muted">UPI (Razorpay)</div></div>
            <div class="pay-opt" data-method="card">üí≥<div class="small muted">Card (Razorpay)</div></div>
            <div class="pay-opt" data-method="netbanking">üè¶<div class="small muted">Netbanking (Razorpay)</div></div>
          </div>

          <div style="display:flex; gap:10px; margin-top:16px">
            <button class="btn ghost" id="backToShipping">Back</button>
            <button class="btn primary" id="placeOrderBtn">Complete order</button>
          </div>

          <div id="paymentError" class="error" style="display:none"></div>
        </div>

        <!-- Thank you -->
        <div id="thankyou" style="display:none" class="card">
          <div class="thank">
            <h2>Order placed ‚Äî thank you!</h2>
            <div class="muted" style="margin-top:6px">A confirmation has been sent to your email (if provided).</div>
            <div style="margin-top:12px" class="small">Shopify order id: <strong id="finalOrderId">-</strong></div>
            <div style="margin-top:14px">
              <button class="btn primary" id="placeAnother">Place another order</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RIGHT: summary -->
    <aside>
      <div class="card summary">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Order summary</h3>
          <div class="small muted">Items: <span id="itemCount">0</span></div>
        </div>

        <div id="itemsList" style="margin-top:10px"></div>

        <div class="totals">
          <div class="line"><div class="small muted">Subtotal</div><div id="subtotal" class="small">‚Çπ0.00</div></div>
          <div class="line"><div class="small muted">Discount</div><div id="discountValue" class="small">-‚Çπ0.00</div></div>
          <div class="line"><div class="small muted">Shipping</div><div id="shippingValue" class="small">‚Çπ0.00</div></div>
          <div class="line total"><div>Total</div><div id="totalPay">‚Çπ0.00</div></div>
        </div>

        <div style="margin-top:12px" class="small muted">Taxes & shipping are estimates ‚Äî final amounts used for payment are shown at checkout.</div>
      </div>
    </aside>
  </div>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
  (function(){
    // CONFIG
    const API_CREATE = '/api/create-razorpay-order';
    const API_VERIFY = '/api/verify-payment';
    const API_CREATE_SHOPIFY_ORDER = '/api/create-shopify-order';
    const API_DISCOUNTS = '/api/discounts';
    const API_PRODUCTS = '/api/products'; // optional

    // State
    let state = {
      cart: { items: [], total_price: 0, items_subtotal_price: 0 },
      customer: {},
      shipping: {},
      selectedPayment: null,
      discount: { applied: false, code: null, amount_paise: 0, price_rule: null },
      shippingFeePaise: 0 // default 0; expand later
    };

    // Elements
    const overlay = document.getElementById('overlay');
    const shopDomainEl = document.getElementById('shopDomain');
    const itemsListEl = document.getElementById('itemsList');
    const subtotalEl = document.getElementById('subtotal');
    const totalEl = document.getElementById('totalPay');
    const discountValEl = document.getElementById('discountValue');
    const itemCountEl = document.getElementById('itemCount');

    const discountMsgEl = document.getElementById('discountMsg');
    const discountInput = document.getElementById('discountCode');

    const paymentOptions = document.getElementById('paymentOptions');
    const paymentErrorEl = document.getElementById('paymentError');

    const placeOrderBtn = document.getElementById('placeOrderBtn');

    // util: show/hide overlay
    function setLoading(show){
      overlay.style.display = show ? 'flex' : 'none';
    }

    function formatPaise(paise){
      return '‚Çπ' + (Number(paise)/100).toFixed(2);
    }

    // Load shop domain from meta (if available) else fallback
    try {
      const shop = window.Shopify && Shopify.shop ? Shopify.shop : (new URL(window.location.href)).hostname;
      shopDomainEl.textContent = shop;
    } catch (e) {
      shopDomainEl.textContent = 'your-store';
    }

    // Load cart
    async function loadCart(){
      try {
        const res = await fetch('/cart.js', {cache:'no-cache'});
        const cart = await res.json();
        state.cart = cart;
        renderSummary();
      } catch (err) {
        console.error('Failed to load cart.js', err);
        itemsListEl.innerHTML = '<div class="small muted">Could not load cart. Add a product to the cart first.</div>';
      }
    }

    function renderSummary(){
      const items = state.cart.items || [];
      itemsListEl.innerHTML = '';
      let count = 0;
      for (const it of items){
        count += (it.quantity || 1);
        const price = it.line_price || (it.price * it.quantity) || 0;
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `<div style="max-width:260px">${escapeHtml(it.product_title || it.title)}<div class="small muted">${escapeHtml(it.variant_title || '')} √ó ${it.quantity}</div></div><div>${formatPaise(price)}</div>`;
        itemsListEl.appendChild(div);
      }
      itemCountEl.textContent = count;
      subtotalEl.textContent = formatPaise(state.cart.items_subtotal_price || state.cart.total_price || 0);
      const disc = state.discount.amount_paise || 0;
      discountValEl.textContent = (disc>0?'-':'') + formatPaise(Math.abs(disc));
      const shipping = state.shippingFeePaise || 0;
      document.getElementById('shippingValue').textContent = formatPaise(shipping);
      const total = Math.max(0, (state.cart.total_price || state.cart.items_subtotal_price || 0) - (disc || 0) + (shipping || 0));
      totalEl.textContent = formatPaise(total);
    }

    // Escape HTML for safety
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // Step navigation
    function setStep(n){
      document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
      document.querySelector(`.step[data-step="${n}"]`).classList.add('active');
      document.getElementById('step-1').style.display = (n===1)?'block':'none';
      document.getElementById('step-2').style.display = (n===2)?'block':'none';
      document.getElementById('step-3').style.display = (n===3)?'block':'none';
    }

    // Event bindings
    document.getElementById('contactForm').addEventListener('submit', function(e){
      e.preventDefault();
      state.customer.fullName = document.getElementById('name').value.trim();
      state.customer.email = document.getElementById('email').value.trim();
      state.customer.phone = document.getElementById('phone').value.trim();
      if (!state.customer.fullName || !state.customer.email) return alert('Name and email are required');
      setStep(2);
    });

    document.getElementById('shippingForm').addEventListener('submit', function(e){
      e.preventDefault();
      state.shipping.street = document.getElementById('street').value.trim();
      state.shipping.city = document.getElementById('city').value.trim();
      state.shipping.postal = document.getElementById('postal').value.trim();
      state.shipping.state = document.getElementById('state').value;
      state.shipping.country = 'India';
      if (!state.shipping.street || !state.shipping.city || !state.shipping.postal) return alert('Complete shipping address required');
      // save if requested
      if (document.getElementById('saveInfo') && document.getElementById('saveInfo').checked){
        localStorage.setItem('shippingInfo', JSON.stringify(state.shipping));
      }
      setStep(3);
    });

    document.getElementById('backToContact').addEventListener('click', ()=> setStep(1));
    document.getElementById('backToShipping').addEventListener('click', ()=> setStep(2));
    document.getElementById('loadCartBtn').addEventListener('click', loadCart);

    // Prefill saved shipping info
    (function tryLoadSaved(){
      try {
        const s = localStorage.getItem('shippingInfo');
        if (s){ const parsed = JSON.parse(s); document.getElementById('street').value = parsed.street||''; document.getElementById('city').value = parsed.city||''; document.getElementById('postal').value = parsed.postal||''; document.getElementById('state').value = parsed.state||''; }
      } catch(e){}
    })();

    // Payment option selection
    paymentOptions.addEventListener('click', function(e){
      const opt = e.target.closest('.pay-opt');
      if (!opt) return;
      paymentOptions.querySelectorAll('.pay-opt').forEach(p => p.classList.remove('selected'));
      opt.classList.add('selected');
      state.selectedPayment = opt.dataset.method;
    });

    // Discount apply
    document.getElementById('applyDiscountBtn').addEventListener('click', applyDiscount);
    async function applyDiscount(e){
      e && e.preventDefault();
      const code = (discountInput.value || '').trim();
      discountMsgEl.textContent = '';
      if (!code) return discountMsgEl.textContent = 'Enter a discount code first';
      setLoading(true);
      try {
        const res = await fetch(API_DISCOUNTS);
        const payload = await res.json();
        if (!res.ok) throw new Error(payload.message || 'Failed to fetch discounts');

        // Flatten codes and find code
        let found = null;
        const blocks = payload.data || payload; // server returns {data: [...] } or {success:true, data:...}
        for (const block of blocks){
          const codes = block.discount_codes || [];
          for (const c of codes){
            if (String(c.code).toLowerCase() === code.toLowerCase()){
              found = { code: c.code, discount_code: c, price_rule: block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule || block.price_rule }; // fallback keep price_rule if included
              // server may include price_rule in block.price_rule or block.price_rule; we'll also try parent
              if (!found.price_rule && block.price_rule) found.price_rule = block.price_rule;
              if (!found.price_rule && block.price_rule) found.price_rule = block.price_rule;
            }
          }
          // also some server responses are {price_rule, discount_codes}
          if (!found && block.price_rule && block.discount_codes){
            for (const c of block.discount_codes){
              if (String(c.code).toLowerCase() === code.toLowerCase()){
                found = { code: c.code, discount_code: c, price_rule: block.price_rule };
              }
            }
          }
        }

        // If still not found, try alternate format
        if (!found && Array.isArray(payload.data)){
          for (const x of payload.data){
            if (x.discount_codes){
              const c = x.discount_codes.find(z => String(z.code).toLowerCase() === code.toLowerCase());
              if (c){ found = { code: c.code, discount_code: c, price_rule: x.price_rule || x.price_rule }; break; }
            }
          }
        }

        if (!found){
          state.discount = { applied:false, code:null, amount_paise:0, price_rule:null };
          renderSummary();
          discountMsgEl.textContent = 'Invalid or expired code';
        } else {
          // Determine discount amount from price_rule
          // price_rule may contain: value_type ("percentage" | "fixed_amount"), value (string), etc.
          const pr = found.price_rule || payload.price_rule || found.price_rule;
          // Try to locate rule by fetching price_rules if we don't have full structure
          let value_type = pr && pr.value_type;
          let value = pr && pr.value;
          // Fallback: sometimes discount code object contains amount info - but likely not. We'll handle basic two cases.
          const total = Number(state.cart.total_price || state.cart.items_subtotal_price || 0);
          let discountPaise = 0;
          if (value_type === 'percentage') {
            discountPaise = Math.round(total * (Number(value) / 100));
          } else if (value_type === 'fixed_amount') {
            // value is in shop currency (e.g., "100.0")
            discountPaise = Math.round(Number(value || 0) * 100);
          } else {
            // unknown; attempt safe fallback: treat as fixed if numeric
            if (!isNaN(Number(value))) discountPaise = Math.round(Number(value) * 100);
          }

          // clamp discount to subtotal
          discountPaise = Math.max(0, Math.min(discountPaise, total));

          state.discount = { applied:true, code: found.code, amount_paise: discountPaise, price_rule: pr || null };
          renderSummary();
          discountMsgEl.textContent = `Applied "${found.code}" ‚Äî saved ‚Çπ${(discountPaise/100).toFixed(2)} off`;
        }
      } catch (err){
        console.error('discounts error', err);
        discountMsgEl.textContent = 'Could not validate discount';
      } finally {
        setLoading(false);
      }
    }

    // Place order behaviour
    placeOrderBtn.addEventListener('click', async function(){
      paymentErrorEl.style.display = 'none';
      if (!state.selectedPayment) { alert('Select a payment method'); return; }
      // ensure shipping filled
      if (!state.shipping || !state.shipping.street) { alert('Please complete shipping info'); setStep(2); return; }

      // compute final amount
      const subtotal = Number(state.cart.total_price || state.cart.items_subtotal_price || 0);
      const discount = Number(state.discount.amount_paise || 0);
      const shippingFee = Number(state.shippingFeePaise || 0);
      const finalAmount = Math.max(0, subtotal - discount + shippingFee);

      if (state.selectedPayment === 'cod'){
        // create order via server as pending (server: /api/create-shopify-order)
        try {
          setLoading(true);
          const res = await fetch(API_CREATE_SHOPIFY_ORDER, {
            method: 'POST',
            headers: {'content-type':'application/json'},
            body: JSON.stringify({ checkout: { cart: state.cart, fullName: state.customer.fullName, email: state.customer.email, phone: state.customer.phone, street: state.shipping.street, city: state.shipping.city, state: state.shipping.state, postal: state.shipping.postal, country: state.shipping.country }, opts: { note: state.discount.applied ? `Discount: ${state.discount.code}` : '' } })
          });
          const json = await res.json();
          setLoading(false);
          if (!res.ok || !json.success) { throw new Error(json.message || 'Failed to create order'); }
          showThankYou(json.shopify_order_id || (json.shopify_order && json.shopify_order.id));
        } catch(err){
          setLoading(false);
          paymentErrorEl.style.display = 'block';
          paymentErrorEl.textContent = 'Failed to create order: ' + (err.message || err);
          console.error(err);
        }
        return;
      }

      // Online payments via Razorpay
      try {
        setLoading(true);
        // create razorpay order
        const createResp = await fetch(API_CREATE, {
          method: 'POST',
          headers: {'content-type':'application/json'},
          body: JSON.stringify({ amount: finalAmount })
        });
        const createJson = await createResp.json();
        setLoading(false);
        if (!createResp.ok) throw new Error(createJson.message || 'Failed to create razorpay order');

        const rzpOrder = createJson.order;
        const keyId = createJson.key_id || createJson.key || createJson.key_id;

        // open Razorpay
        const options = {
          key: keyId,
          amount: rzpOrder.amount,
          currency: rzpOrder.currency || 'INR',
          name: (document.title || 'Your Store'),
          description: 'Order payment',
          order_id: rzpOrder.id,
          prefill: { name: state.customer.fullName || '', email: state.customer.email || '', contact: state.customer.phone || '' },
          theme: { color: '#667eea' },
          handler: async function(resp){
            // verify and create shopify order
            setLoading(true);
            try {
              const verifyResp = await fetch(API_VERIFY, {
                method: 'POST',
                headers: {'content-type':'application/json'},
                body: JSON.stringify({
                  razorpay_order_id: resp.razorpay_order_id,
                  razorpay_payment_id: resp.razorpay_payment_id,
                  razorpay_signature: resp.razorpay_signature,
                  checkoutData: {
                    cart: state.cart,
                    fullName: state.customer.fullName,
                    email: state.customer.email,
                    phone: state.customer.phone,
                    street: state.shipping.street,
                    city: state.shipping.city,
                    state: state.shipping.state,
                    postal: state.shipping.postal,
                    country: state.shipping.country,
                    discount: state.discount.applied ? { code: state.discount.code, amount_paise: state.discount.amount_paise } : null
                  }
                })
              });
              const verifyJson = await verifyResp.json();
              setLoading(false);
              if (!verifyResp.ok || !verifyJson.success) {
                throw new Error((verifyJson && (verifyJson.message || JSON.stringify(verifyJson))) || 'verification failed');
              }
              showThankYou(verifyJson.shopify_order_id || (verifyJson.shopify_order && verifyJson.shopify_order.id));
            } catch (err){
              setLoading(false);
              paymentErrorEl.style.display='block';
              paymentErrorEl.textContent = 'Payment succeeded but we could not create the order: ' + (err.message || err);
              console.error('verify/create order error', err);
            }
          },
          modal: { ondismiss: function(){ setLoading(false); } }
        };

        const rzp = new Razorpay(options);
        rzp.open();

      } catch (err){
        setLoading(false);
        paymentErrorEl.style.display='block';
        paymentErrorEl.textContent = 'Payment error: ' + (err.message || err);
        console.error('placeOrder error', err);
      }
    });

    // Thank you UI
    function showThankYou(orderId){
      document.querySelectorAll('.card').forEach(c => c.style.display = 'none');
      document.getElementById('thankyou').style.display = 'block';
      document.getElementById('finalOrderId').textContent = orderId || ('ORD' + Date.now());
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // Init
    (async function init(){
      setStep(1);
      setLoading(true);
      await loadCart();
      setLoading(false);
    })();

    // Public helper: load discounts on focus (speed)
    discountInput.addEventListener('focus', function(){ /* could prefetch discounts */ });

  })();
  </script>
</body>
</html>
